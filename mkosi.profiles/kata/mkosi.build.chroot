#!/bin/bash

set -e

((INCREMENTAL)) && ((KATA)) && exit 0

if [[ ! -f "${DESTDIR}/opt/kata/bin/kata-runtime" ]]; then
        if [[ ! -f "${BUILDDIR}/kata-static.tar.xz" ]]; then
                VERSION=$(curl -s https://api.github.com/repos/kata-containers/kata-containers/releases/latest |
                        grep '"tag_name":' |
                        sed -E 's/.*"([^"]+)".*/\1/')
                curl -SL https://github.com/kata-containers/kata-containers/releases/download/"${VERSION}"/kata-static-"${VERSION}"-amd64.tar.xz -o "${BUILDDIR}/kata-static.tar.xz"
        fi
        tar -xvf "${BUILDDIR}/kata-static.tar.xz" -C "${DESTDIR}"
fi

cd "${DESTDIR}"/opt/kata/bin
find . -type f -name '*kata*' -exec ln -s /opt/kata/bin/{} "${DESTDIR}"/usr/local/bin/ \;
sed -i 's|/opt/kata/bin/qemu-system-x86_64|/work/build/qemu/qemu-system-x86_64|' "${DESTDIR}"/opt/kata/share/defaults/kata-containers/configuration.toml
sed -i 's|/opt/kata/libexec/virtiofsd|/work/build/virtiofsd/release/virtiofsd|g' "${DESTDIR}"/opt/kata/share/defaults/kata-containers/configuration.toml
sed -i 's|/opt/kata/share/kata-containers/vmlinux.container|/work/build/kata-guest/vmlinux|' "${DESTDIR}"/opt/kata/share/defaults/kata-containers/configuration.toml
